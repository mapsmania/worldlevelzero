<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Europe Four-Color Map Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link
  href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"
  rel="stylesheet"
/>

<style>
  body {
    margin: 0;
    overflow: hidden;
    font-family: sans-serif;
  }
  #map {
    position: absolute;
    top: 0; right: 0; bottom: 0; left: 0;
  }
  #toolbar {
    position: absolute;
    top: 10px;
    left: 10px;
    background: white;
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 14px;
    box-shadow: 0 0 8px rgba(0,0,0,0.2);
  }
  #color-buttons button {
    width: 26px;
    height: 26px;
    border-radius: 5px;
    cursor: pointer;
    border: 2px solid black;
  }
  #status {
    margin-top: 6px;
    font-weight: bold;
  }
</style>
</head>

<body>
<div id="map"></div>

<div id="toolbar">
  <div><strong>Four-Color Map Game</strong></div>
  <div>Select a color, then click a country.</div>

  <div id="color-buttons" style="margin-top:6px; display:flex; gap:8px;">
    <button class="color-btn" data-color="0" style="background:#e74c3c;"></button>
    <button class="color-btn" data-color="1" style="background:#27ae60;"></button>
    <button class="color-btn" data-color="2" style="background:#2980b9;"></button>
    <button class="color-btn" data-color="3" style="background:#f1c40f;"></button>
  </div>

  <div id="status"></div>
</div>

<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
<script>

// -----------------------------------------------------------------------------
// 1. Setup Map
// -----------------------------------------------------------------------------
const map = new maplibregl.Map({
  container: "map",
  style: "https://demotiles.maplibre.org/style.json",
  center: [13, 52],
  zoom: 3.7
});

const GEOJSON_URL = 
  "https://mapsmania.github.io/worldlevelzero/CountryRecall/world.geojson";

const COLORS = ["#e74c3c", "#27ae60", "#2980b9", "#f1c40f"];
let selectedColor = 0;           // The chosen color button
let countryState = {};           // { featureId: colorIndex }
let adjacency = {};              // { featureId: [neighbors...] }


// -----------------------------------------------------------------------------
// 2. Load Europe features + set IDs + compute adjacency
// -----------------------------------------------------------------------------
async function fetchGeoJSON() {
  const res = await fetch(GEOJSON_URL);
  const geo = await res.json();

  geo.features = geo.features.filter(f =>
    f.properties.continent === "Europe"
  );

  geo.features.forEach((f, i) => {
    f.id = i + 1;
    f.properties.id = i + 1;
  });

  adjacency = computeAdjacency(geo.features);
  return geo;
}


// -----------------------------------------------------------------------------
// 3. Compute country adjacency
// -----------------------------------------------------------------------------
function computeAdjacency(features) {
  const neighbors = {};
  for (let i = 0; i < features.length; i++) {
    const a = features[i];
    neighbors[a.id] = [];

    const aBox = bbox(a.geometry);

    for (let j = 0; j < features.length; j++) {
      if (i === j) continue;
      const b = features[j];
      const bBox = bbox(b.geometry);

      if (!boxesIntersect(aBox, bBox)) continue;
      if (sharesBorder(a.geometry, b.geometry)) {
        neighbors[a.id].push(b.id);
      }
    }
  }
  return neighbors;
}

function bbox(geom) {
  let coords = geom.coordinates.flat(2);
  let xs = coords.map(c => c[0]);
  let ys = coords.map(c => c[1]);
  return [Math.min(...xs), Math.min(...ys), Math.max(...xs), Math.max(...ys)];
}

function boxesIntersect(a, b) {
  return !(b[0] > a[2] || b[2] < a[0] || b[1] > a[3] || b[3] < a[1]);
}

function sharesBorder(g1, g2) {
  const edges1 = edges(g1.coordinates);
  const edges2 = edges(g2.coordinates);
  const eps = 0.0005;

  for (const e1 of edges1) {
    for (const e2 of edges2) {
      if (pointsEqual(e1[0], e2[0], eps) && pointsEqual(e1[1], e2[1], eps)) return true;
      if (pointsEqual(e1[0], e2[1], eps) && pointsEqual(e1[1], e2[0], eps)) return true;
    }
  }
  return false;
}

function edges(coords) {
  const list = [];
  for (const poly of coords) {
    for (let i = 0; i < poly.length - 1; i++) {
      list.push([poly[i], poly[i + 1]]);
    }
  }
  return list;
}

function pointsEqual(a, b, eps) {
  return Math.abs(a[0] - b[0]) < eps && Math.abs(a[1] - b[1]) < eps;
}


// -----------------------------------------------------------------------------
// 4. Map layers + interaction
// -----------------------------------------------------------------------------
map.on("load", async () => {
  const geo = await fetchGeoJSON();

  map.addSource("europe", {
    type: "geojson",
    data: geo,
    promoteId: "id"
  });

  map.addLayer({
    id: "europe-base",
    source: "europe",
    type: "fill",
    paint: {
      "fill-color": "#cccccc",
      "fill-outline-color": "#000"
    }
  });

  map.addLayer({
    id: "europe-colored",
    source: "europe",
    type: "fill",
    paint: {
      "fill-color": [
        "match",
          ["feature-state", "colorIndex"],
          0, COLORS[0],
          1, COLORS[1],
          2, COLORS[2],
          3, COLORS[3],
          "#cccccc"
      ],
      "fill-outline-color": "#000"
    }
  });

  map.on("click", "europe-colored", handleClick);
});


// -----------------------------------------------------------------------------
// 5. Handle country click using SELECTED COLOR
// -----------------------------------------------------------------------------
function handleClick(e) {
  const feature = e.features[0];
  const id = feature.id;

  const next = selectedColor;

  if (!validMove(id, next)) {
    showStatus("❌ Invalid move — adjacent country uses this color.");
    return;
  }

  countryState[id] = next;

  map.setFeatureState(
    { source: "europe", id },
    { colorIndex: next }
  );

  showStatus("✔ Color applied!");
}

function validMove(id, colorIndex) {
  return adjacency[id].every(nId => countryState[nId] !== colorIndex);
}

function showStatus(msg) {
  document.getElementById("status").textContent = msg;
}


// -----------------------------------------------------------------------------
// 6. Color selection buttons
// -----------------------------------------------------------------------------
document.addEventListener("DOMContentLoaded", () => {
  const buttons = document.querySelectorAll(".color-btn");

  function updateSelectedButton() {
    buttons.forEach(btn => {
      if (parseInt(btn.dataset.color) === selectedColor) {
        btn.style.outline = "3px solid black";
      } else {
        btn.style.outline = "none";
      }
    });
  }

  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      selectedColor = parseInt(btn.dataset.color);
      updateSelectedButton();
      showStatus("Color selected.");
    });
  });

  updateSelectedButton();
});

</script>
</body>
</html>
