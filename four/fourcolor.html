<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Europe Four-Color Map Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link
  href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"
  rel="stylesheet"
/>

<style>
  body {
    margin: 0;
    overflow: hidden;
    font-family: sans-serif;
  }
  #map {
    position: absolute;
    top: 0; right: 0; bottom: 0; left: 0;
  }
  #toolbar {
    position: absolute;
    top: 10px;
    left: 10px;
    background: white;
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 14px;
    box-shadow: 0 0 8px rgba(0,0,0,0.2);
  }
  #color-buttons button {
    width: 26px;
    height: 26px;
    border-radius: 5px;
    cursor: pointer;
    border: 2px solid black;
  }
  #status {
    margin-top: 6px;
    font-weight: bold;
  }
</style>
</head>

<body>
<div id="map"></div>

<div id="toolbar">
  <div><strong>Four-Color Map Game</strong></div>
  <div>Select a color, then click a country.</div>

  <div id="color-buttons" style="margin-top:6px; display:flex; gap:8px;">
    <button class="color-btn" data-color="0" style="background:#e74c3c;"></button>
    <button class="color-btn" data-color="1" style="background:#27ae60;"></button>
    <button class="color-btn" data-color="2" style="background:#2980b9;"></button>
    <button class="color-btn" data-color="3" style="background:#f1c40f;"></button>
  </div>

  <div id="status"></div>
</div>

<script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
<script>

// -----------------------------------------------------------------------------
// 1. Setup Map
// -----------------------------------------------------------------------------
const map = new maplibregl.Map({
  container: "map",
  style: {
    version: 8,
    sources: {},
    layers: [
      {
        id: "background",
        type: "background",
        paint: {
          "background-color": "#ffffff"  // plain white background
        }
      }
    ]
  },
  center: [13, 52],
  zoom: 3.7
});

const GEOJSON_URL = 
  "https://mapsmania.github.io/worldlevelzero/CountryRecall/world.geojson";

const COLORS = ["#e74c3c", "#27ae60", "#2980b9", "#f1c40f"];
let selectedColor = 0;
let countryState = {};
let adjacency = {};
let gameWon = false;

// -----------------------------------------------------------------------------
// 2. Load Europe features + compute adjacency
// -----------------------------------------------------------------------------
async function fetchGeoJSON() {
  const res = await fetch(GEOJSON_URL);
  const geo = await res.json();

  geo.features = geo.features.filter(f =>
    f.properties.continent === "Europe"
  );

  geo.features.forEach((f, i) => {
    f.id = i + 1;
    f.properties.id = i + 1;
  });

  adjacency = computeAdjacencyTurf(geo.features);
  return geo;
}

// -----------------------------------------------------------------------------
// 3. Compute adjacency using Turf.js (handles Polygon + MultiPolygon)
// -----------------------------------------------------------------------------
function computeAdjacencyTurf(features) {
  const neighbors = {};
  for (let i = 0; i < features.length; i++) {
    const a = features[i];
    const aId = Number(a.id);
    neighbors[aId] = [];

    const polysA = (a.geometry.type === "Polygon")
      ? [turf.polygon(a.geometry.coordinates)]
      : a.geometry.coordinates.map(c => turf.polygon(c));

    for (let j = 0; j < features.length; j++) {
      if (i === j) continue;
      const b = features[j];
      const bId = Number(b.id);
      const polysB = (b.geometry.type === "Polygon")
        ? [turf.polygon(b.geometry.coordinates)]
        : b.geometry.coordinates.map(c => turf.polygon(c));

      let touches = false;
      for (const pa of polysA) {
        for (const pb of polysB) {
          if (turf.booleanTouches(pa, pb) || turf.booleanIntersects(pa, pb)) {
            touches = true;
            break;
          }
        }
        if (touches) break;
      }

      if (touches) neighbors[aId].push(bId);
    }
  }
  return neighbors;
}

// -----------------------------------------------------------------------------
// 4. Map layers + interaction
// -----------------------------------------------------------------------------
map.on("load", async () => {
  const geo = await fetchGeoJSON();

  map.addSource("europe", {
    type: "geojson",
    data: geo,
    promoteId: "id"
  });

  map.addLayer({
    id: "europe-base",
    source: "europe",
    type: "fill",
    paint: {
      "fill-color": "#cccccc",
      "fill-outline-color": "#000"
    }
  });

  map.addLayer({
    id: "europe-colored",
    source: "europe",
    type: "fill",
    paint: {
      "fill-color": [
        "match",
          ["feature-state", "colorIndex"],
          0, COLORS[0],
          1, COLORS[1],
          2, COLORS[2],
          3, COLORS[3],
          "#cccccc"
      ],
      "fill-outline-color": "#000"
    }
  });

  map.on("click", "europe-colored", handleClick);
});

// -----------------------------------------------------------------------------
// 5. Handle country click
// -----------------------------------------------------------------------------
function handleClick(e) {
  if (gameWon) return;

  const feature = e.features[0];
  const id = Number(feature.id);

  if (!validMove(id, selectedColor)) {
    showStatus("âŒ Invalid move â€” adjacent country uses this color.");
    return;
  }

  countryState[id] = selectedColor;

  map.setFeatureState(
    { source: "europe", id },
    { colorIndex: selectedColor }
  );

  showStatus("âœ” Color applied!");

  checkWin();
}

// -----------------------------------------------------------------------------
// 6. Valid move function
// -----------------------------------------------------------------------------
function validMove(id, colorIndex) {
  const neighbors = adjacency[Number(id)] || [];
  return neighbors.every(nId => countryState[nId] !== colorIndex);
}

// -----------------------------------------------------------------------------
// 7. Check win condition
// -----------------------------------------------------------------------------
function checkWin() {
  const allColored = Object.keys(adjacency).every(id => countryState[id] !== undefined);
  if (allColored) {
    gameWon = true;
    showStatus("ðŸ† Congratulations! All countries successfully colored!");
  }
}

// -----------------------------------------------------------------------------
// 8. Show status messages
// -----------------------------------------------------------------------------
function showStatus(msg) {
  document.getElementById("status").textContent = msg;
}

// -----------------------------------------------------------------------------
// 9. Color selection buttons
// -----------------------------------------------------------------------------
document.addEventListener("DOMContentLoaded", () => {
  const buttons = document.querySelectorAll(".color-btn");

  function updateSelectedButton() {
    buttons.forEach(btn => {
      btn.style.outline = (parseInt(btn.dataset.color) === selectedColor) ? "3px solid black" : "none";
    });
  }

  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      selectedColor = parseInt(btn.dataset.color);
      updateSelectedButton();
      showStatus("Color selected.");
    });
  });

  updateSelectedButton();
});

</script>
</body>
</html>
